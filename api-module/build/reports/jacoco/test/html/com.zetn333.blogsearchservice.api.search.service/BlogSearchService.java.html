<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BlogSearchService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">api-module</a> &gt; <a href="index.source.html" class="el_package">com.zetn333.blogsearchservice.api.search.service</a> &gt; <span class="el_source">BlogSearchService.java</span></div><h1>BlogSearchService.java</h1><pre class="source lang-java linenums">package com.zetn333.blogsearchservice.api.search.service;

import com.zetn333.blogsearchservice.api.common.constansts.ErrorCode;
import com.zetn333.blogsearchservice.api.common.constansts.OpenApi;
import com.zetn333.blogsearchservice.api.common.dto.PageResponse;
import com.zetn333.blogsearchservice.api.common.exception.CustomServiceException;
import com.zetn333.blogsearchservice.api.search.dto.*;
import com.zetn333.blogsearchservice.common.entity.SearchStatusEntity;
import com.zetn333.blogsearchservice.common.repository.SearchStatusRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.modelmapper.ModelMapper;
import org.modelmapper.TypeToken;
import org.springframework.http.HttpHeaders;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.ObjectUtils;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientException;

import java.math.BigInteger;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

<span class="fc" id="L28">@Slf4j</span>
<span class="fc" id="L29">@RequiredArgsConstructor</span>
@Transactional(readOnly = true)
@Service
public class BlogSearchService {

    private final ModelMapper modelMapper;
    private final WebClient webClient;

    private final SearchStatusRepository searchStatusRepository;

    /**
     * 블로그 검색
     * @param  searchBlogRequest 검색 조건
     * @return SearchBlogResponse 블로그 검색 결과 정보
     */
    @Transactional
    public SearchBlogResponse searchBlog(SearchBlogRequest searchBlogRequest) {
        SearchBlogResponse searchBlogResponse;

        try {
            // 카카오 API
<span class="fc" id="L50">            searchBlogResponse = requestKakaoApi(searchBlogRequest);</span>
<span class="nc" id="L51">        } catch (WebClientException e) {</span>
<span class="nc" id="L52">            throw CustomServiceException.of(ErrorCode.SERVER_ERROR_OPEN_API);</span>
            // TODO: 네이버 API
<span class="fc" id="L54">        }</span>

        // 검색 현황 테이블 업데이트
<span class="fc" id="L57">        updateSearchKeywordStatus(searchBlogRequest);</span>

<span class="fc" id="L59">        return searchBlogResponse;</span>
    }

    /**
     * 카카오 블로그 검색 API 호출
     * @param searchBlogRequest
     * @return SearchBlogResponse 검색된 블로그 정보
     */
    private SearchBlogResponse requestKakaoApi(SearchBlogRequest searchBlogRequest) {

        // WebClient를 이용하여 카카오 API 요청 스펙에 맞춰 REST API 호출 - OpenApi Class 정의 참조
        // https://developers.kakao.com/docs/latest/ko/daum-search/dev-guide#search-blog

        // 필수값이 아닌 요청 파라미터 초기 세팅
<span class="fc bfc" id="L73" title="All 2 branches covered.">        if (ObjectUtils.isEmpty(searchBlogRequest.getPage().getPageNumber())) {</span>
<span class="fc" id="L74">            searchBlogRequest.getPage().setPageNumber(Integer.valueOf(OpenApi.kakaoBlogSearchParams.PAGE_NUMBER.getDefaultValue()));</span>
        }
<span class="fc bfc" id="L76" title="All 2 branches covered.">        if (ObjectUtils.isEmpty(searchBlogRequest.getPage().getPageSize())) {</span>
<span class="fc" id="L77">            searchBlogRequest.getPage().setPageSize(Integer.valueOf(OpenApi.kakaoBlogSearchParams.PAGE_SIZE.getDefaultValue()));</span>
        }
<span class="fc bfc" id="L79" title="All 2 branches covered.">        if (ObjectUtils.isEmpty(searchBlogRequest.getPage().getSort())) {</span>
<span class="fc" id="L80">            searchBlogRequest.getPage().setSort(OpenApi.kakaoBlogSearchParams.PAGE_SORT.getDefaultValue());</span>
        }

<span class="fc" id="L83">        KakaoBlogSearchResponseDto kakaoBlogSearchResponseDto = webClient.get()</span>
<span class="fc" id="L84">                .uri(OpenApi.KAKAO_BLOG_SEARCH.getUrl(),</span>
<span class="fc" id="L85">                        uriBuilder -&gt; uriBuilder</span>
<span class="fc" id="L86">                                .queryParam(OpenApi.kakaoBlogSearchParams.SEARCH_KEYWORD.getValue(), searchBlogRequest.getSearchWord())</span>
<span class="fc" id="L87">                                .queryParam(OpenApi.kakaoBlogSearchParams.PAGE_NUMBER.getValue(), searchBlogRequest.getPage().getPageNumber())</span>
<span class="fc" id="L88">                                .queryParam(OpenApi.kakaoBlogSearchParams.PAGE_SIZE.getValue(), searchBlogRequest.getPage().getPageSize())</span>
<span class="fc" id="L89">                                .queryParam(OpenApi.kakaoBlogSearchParams.PAGE_SORT.getValue(), searchBlogRequest.getPage().getSort())</span>
<span class="fc" id="L90">                                .build())</span>
<span class="fc" id="L91">                .header(HttpHeaders.AUTHORIZATION, OpenApi.KAKAO_BLOG_SEARCH.getKey())</span>
<span class="fc" id="L92">                .retrieve()</span>
<span class="fc" id="L93">                .bodyToMono(KakaoBlogSearchResponseDto.class)</span>
<span class="fc" id="L94">                .block();</span>

<span class="fc" id="L96">        List&lt;SearchBlogPostResponse&gt; searchBlogPostResponses = new ArrayList&lt;&gt;();</span>

        // 카카오 API 응답 값을 서비스 API 응답 스펙에 맞춰 매핑
        // KakaoBlogSearchResponseDto -&gt; PageResponse 매핑
<span class="fc" id="L100">        PageResponse pageResponse = PageResponse.builder()</span>
<span class="fc" id="L101">                .pageNumber(searchBlogRequest.getPage().getPageNumber())</span>
<span class="fc" id="L102">                .pageSize(searchBlogRequest.getPage().getPageSize())</span>
<span class="fc" id="L103">                .totalCount(kakaoBlogSearchResponseDto.getMeta().getTotal_count())</span>
<span class="fc" id="L104">                .pageableCount(kakaoBlogSearchResponseDto.getMeta().getPageable_count())</span>
<span class="fc" id="L105">                .isEnd(kakaoBlogSearchResponseDto.getMeta().getIs_end())</span>
<span class="fc" id="L106">                .build();</span>

        // KakaoBlogSearchResponseDto -&gt; SearchBlogPostResponse 매핑
<span class="fc" id="L109">        kakaoBlogSearchResponseDto.getDocuments().forEach(document -&gt; {</span>
<span class="fc" id="L110">            SearchBlogPostResponse searchBlogPostResponse = SearchBlogPostResponse.builder()</span>
<span class="fc" id="L111">                    .postTitle(document.getTitle())</span>
<span class="fc" id="L112">                    .postContentsSummary(document.getContents())</span>
<span class="fc" id="L113">                    .postUrl(document.getUrl())</span>
<span class="fc" id="L114">                    .blogName(document.getBlogname())</span>
<span class="fc" id="L115">                    .thumbnailUrl(document.getThumbnail())</span>
<span class="fc" id="L116">                    .writeDateTime(document.getDatetime())</span>
<span class="fc" id="L117">                    .build();</span>

<span class="fc" id="L119">            searchBlogPostResponses.add(searchBlogPostResponse);</span>
<span class="fc" id="L120">        });</span>

<span class="fc" id="L122">        log.info(&quot;kakao api response = {}&quot;, SearchBlogResponse.of(pageResponse, searchBlogPostResponses));</span>

<span class="fc" id="L124">        return SearchBlogResponse.of(pageResponse, searchBlogPostResponses);</span>
    }

    /**
     * 검색 키워드 현황 업데이트
     * 검색 시간 절감을 위해 비동기 처리
     * @param searchBlogRequest
     * @return SearchStatusEntity 업데이트 된 엔티티
     */
    @Async
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public SearchStatusEntity updateSearchKeywordStatus(SearchBlogRequest searchBlogRequest) {
        // 기존 검색 키워드 조회
<span class="fc" id="L137">        SearchStatusEntity searchStatusEntity = searchStatusRepository.findBySearchKeyword(searchBlogRequest.getSearchWord());</span>

<span class="fc" id="L139">        log.info(&quot;searchStatusEntity before = {}&quot;, searchStatusEntity);</span>

<span class="fc bfc" id="L141" title="All 2 branches covered.">        if (ObjectUtils.isEmpty(searchStatusEntity)) {</span>
            // 기존 검색 키워드가 존재하지 않는 경우, 새 엔티티 생성
<span class="fc" id="L143">            searchStatusEntity = SearchStatusEntity.builder()</span>
<span class="fc" id="L144">                    .searchKeyword(searchBlogRequest.getSearchWord())</span>
<span class="fc" id="L145">                    .searchCount(BigInteger.ONE)</span>
<span class="fc" id="L146">                    .lastSearchDateTime(LocalDateTime.now())</span>
<span class="fc" id="L147">                    .build();</span>
        } else {
            // 기존 검색 키워드가 존재하는 경우, 엔티티 검색 횟수 증가 및 최근 검색 일시 업데이트
<span class="fc" id="L150">            searchStatusEntity.plusSearchCount();</span>
<span class="fc" id="L151">            searchStatusEntity.updateLastSearchDateTime();</span>
        }

<span class="fc" id="L154">        log.info(&quot;searchStatusEntity after = {}&quot;, searchStatusEntity);</span>

        // 엔티티 등록 및 수정
<span class="fc" id="L157">        searchStatusEntity = searchStatusRepository.save(searchStatusEntity);</span>

<span class="fc" id="L159">        return searchStatusEntity;</span>
    }

    /**
     * 인기 검색 키워드 목록 조회
     * @param selectHotKeywordsRequest
     * @return SelectHotKeywordsResponse 인기 검색 키워드 조회 결과 정보
     */
    public SelectHotKeywordsResponse selectHotKeywords(SelectHotKeywordsRequest selectHotKeywordsRequest) {

        // 사용자들이 많이 검색한 순서대로, 최대 10개의 검색 키워드를 제공
<span class="fc" id="L170">        List&lt;SearchStatusEntity&gt; searchStatusEntities = searchStatusRepository.findTop10BySearchCountDesc();</span>

<span class="fc" id="L172">        log.info(&quot;hotKeywords = {}&quot;, searchStatusEntities);</span>

<span class="fc" id="L174">        return SelectHotKeywordsResponse.of(modelMapper.map(</span>
<span class="fc" id="L175">                searchStatusEntities, new TypeToken&lt;List&lt;SelectHotKeywordResponse&gt;&gt;() {}.getType()));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>